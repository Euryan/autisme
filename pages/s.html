<!DOCTYPE html>
<html lang="en">
<head>
  <title>Screening Eye-Tracking</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="../css/vendor.css">
  <link rel="stylesheet" type="text/css" href="../style.css">

  <style>
    /* sembunyikan overlay webcam WebGazer (opsional) */
    #webgazerVideoFeed,
    #webgazerFaceOverlay,
    #webgazerFaceFeedbackBox {
      display: none !important;
    }
    /* pastikan heatmap container overlay absolute di atas video */
    #videoContainer { position: relative; display: inline-block; }
    #heatmapContainer { position: absolute; top: 0; left: 0; pointer-events: none; }
  </style>
</head>
<body>

  <!-- Navbar -->
  <header id="header">
    <nav id="primary-header" class="navbar navbar-expand-lg sticky-top">
      <div class="container">
        <a class="navbar-brand" href="index.html">
          <img src="../images/main-logo.png" class="logo img-fluid">
        </a>
      </div>
    </nav>
  </header>

  <!-- Page Title -->
  <section class="py-5 bg-light text-center">
    <div class="container">
      <h1 class="display-5 fw-bold">Screening Eye-Tracking</h1>
      <p class="text-muted">Lakukan tes singkat sebelum melanjutkan ke pertanyaan.</p>
    </div>
  </section>

  <!-- Eye Tracking Test -->
  <section id="eye-tracking" class="py-5">
    <div class="container text-center">
      <button id="openModalBtn" class="btn btn-primary rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#eyeTrackingModal">
        Lakukan Test!
      </button>

      <!-- Hasil -->
      <div class="mt-4">
        <h5>Hasil:</h5>
        <p id="eyeTrackingResult" class="text-muted">Belum ada hasil</p>
      </div>

      <!-- Tombol Lanjut -->
      <div class="mt-5">
        <a href="test-question.html" class="btn btn-success rounded-pill px-4">Lanjut ke Pertanyaan</a>
      </div>
    </div>
  </section>

  <!-- Modal Eye Tracking -->
  <div class="modal fade" id="eyeTrackingModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Tes Eye-Tracking</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">

          <!-- Video + Heatmap Overlay -->
          <div id="videoContainer">
            <video id="testVideo" width="960" height="540" controls>
              <source src="../images/download.mp4" type="video/mp4">
              Your browser does not support HTML5 video.
            </video>
            <div id="heatmapContainer"></div>
          </div>

          <p id="status" class="mt-3 text-muted">Status: Menunggu mulai...</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
          <button type="button" class="btn btn-primary" id="finishBtn">Selesai</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="bg-dark text-white py-4 text-center">
    <p class="mb-0">© 2025 Autism Project. All rights reserved.</p>
  </footer>

  <!-- Libraries (urutan penting: heatmap, webgazer, bootstrap) -->
  <script src="https://cdn.jsdelivr.net/npm/heatmapjs@2.0.5/heatmap.min.js"></script>
  <script src="https://webgazer.cs.brown.edu/webgazer.js"></script> <!-- resmi -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Script inisialisasi -->
  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const modalEl = document.getElementById('eyeTrackingModal');
    const video = document.getElementById('testVideo');
    const statusText = document.getElementById('status');
    const heatmapContainer = document.getElementById('heatmapContainer');
    const resultEl = document.getElementById('eyeTrackingResult');
    const finishBtn = document.getElementById('finishBtn');

    let heatmap = null;
    let gazeData = [];
    let webgazerStarted = false;
    let autoStopTimer = null;
    let videoPlayHandler = null;

    function createHeatmapForVideo() {
      // atur ukuran container sesuai video saat modal ditampilkan
      const rect = video.getBoundingClientRect();
      heatmapContainer.style.width = rect.width + 'px';
      heatmapContainer.style.height = rect.height + 'px';
      heatmapContainer.style.top = video.offsetTop + 'px';
      heatmapContainer.style.left = video.offsetLeft + 'px';

      // clear existing heatmap instance if ada
      if (heatmap && heatmap._renderer) {
        try { heatmap._renderer.setDimensions(rect.width, rect.height); } catch (e) { /* ignore */ }
      } else {
        heatmap = h337.create({
          container: heatmapContainer,
          radius: Math.round(Math.max(rect.width, rect.height) * 0.03), // radius proporsional
          maxOpacity: 0.6,
          blur: 0.9,
          backgroundColor: 'rgba(0,0,0,0)'
        });
      }
    }

    function startWebGazerTracking() {
      if (typeof webgazer === 'undefined') {
        statusText.innerText = 'Error: webgazer tidak ditemukan. Pastikan koneksi internet & script webgazer ter-load.';
        return;
      }

      // hanya inisialisasi webgazer sekali
      if (!webgazerStarted) {
        try {
          webgazer.setRegression('ridge'); // default regression
        } catch(e) { /* ignore if method not available */ }

        // aktifkan titik prediksi (opsional)
        try { webgazer.showPredictionPoints(true); } catch (e) {}

        webgazer.begin(); // mulai webcam & model
        webgazerStarted = true;
      }

      // siapkan listener
      webgazer.setGazeListener((data) => {
        if (!data) return;
        // ubah koordinat global menjadi relatif terhadap kontainer heatmap
        const rect = heatmapContainer.getBoundingClientRect();
        const xRel = data.x - rect.left;
        const yRel = data.y - rect.top;
        if (xRel >= 0 && yRel >= 0 && xRel <= rect.width && yRel <= rect.height) {
          const pt = { x: Math.round(xRel), y: Math.round(yRel), value: 1, t: Date.now() };
          gazeData.push(pt);
          if (heatmap) heatmap.addData(pt);
        }
      });
    }

    modalEl.addEventListener('shown.bs.modal', () => {
      statusText.innerText = 'Status: Menunggu video/play untuk mulai tracking...';
      gazeData = [];

      // ukuran heatmap diset ulang sesuai ukuran video (video harus sudah layout)
      setTimeout(createHeatmapForVideo, 100); // delay kecil agar layout modal stabil

      // mulai webgazer (permintaan camera akan muncul)
      startWebGazerTracking();

      // jika user menekan play pada video -> mulai timer 30s
      videoPlayHandler = () => {
        statusText.innerText = 'Status: Video diputar. Tracking dimulai (30s).';
        // clear sebelumnya
        if (autoStopTimer) clearTimeout(autoStopTimer);
        autoStopTimer = setTimeout(() => {
          video.pause();
          finishTest();
        }, 30000);
      };
      video.addEventListener('play', videoPlayHandler);
      // jika video otomatis play fails (browser blocks autoplay), user harus tekan play:
      // kita tetap menunggu event 'play'
    });

    modalEl.addEventListener('hidden.bs.modal', () => {
      // bersihkan listener & timer
      if (videoPlayHandler) video.removeEventListener('play', videoPlayHandler);
      if (autoStopTimer) { clearTimeout(autoStopTimer); autoStopTimer = null; }
      try { webgazer.clearGazeListener(); webgazer.pause(); } catch(e) {}
      statusText.innerText = 'Status: Tracking berhenti.';
    });

    // tombol selesai manual
    window.finishTest = function() {
      try { webgazer.clearGazeListener(); webgazer.pause(); } catch(e) {}
      if (autoStopTimer) { clearTimeout(autoStopTimer); autoStopTimer = null; }
      statusText.innerText = 'Status: Tes selesai — menampilkan heatmap.';
      // tampilkan ringkasan hasil (contoh sederhana)
      const total = gazeData.length;
      let summary = 'Tidak ada data';
      if (total > 0) {
        summary = `Jumlah titik: ${total}.`;
      }
      resultEl.innerText = summary;

      // kirim data ke server (endpoint /save-gaze harus kamu siapkan)
      fetch('/save-gaze', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ meta: { startedAt: Date.now() }, points: gazeData })
      }).then(r => r.ok ? console.log('ok') : console.warn('non-ok')).catch(err => console.warn('save error', err));
    };

    // tombol Selesai modal
    finishBtn.addEventListener('click', () => window.finishTest());
  });
  </script>
</body>
</html>
